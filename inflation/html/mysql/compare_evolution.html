<!DOCTYPE html>

<html>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
<script  src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" integrity="sha512-UXumZrZNiOwnTcZSHLOfcTs0aos2MzBWHXOHOuB0J/R44QB0dwY5JgfbvljXcklVf65Gc4El6RjZ+lnwd2az2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js" integrity="sha512-wUYbRPLV5zs6IqvWd88HIqZU/b8TBx+I8LEioQ/UC0t5EMCLApqhIAnUg7EsAzdbhhdgW07TqYDdH3QEXRcPOQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<head>
    <title>Compare tool</title>
    <style type="text/css">
        .chart-container {
            width: 640px;
            height: auto;
        }

        .chartBox {
            width: 750px;
        }

        .input_field_class {
            width: 200px;
        }

        .readonly_field_class {
            width: 200px;
            background-color: #a9a9a93c;
            border: none;
        }

        .slidecontainer {
            width: 200px;
            /* Width of the outside container */
        }
    </style>

</head>

<body>
    <h2>Compare</h2>

    <table>
        <tr>
            <td> First category </td>
            <td>
                <input type="checkbox" id="enable1_checkbox" name="enable1_checkbox" onchange="updateGraph()" checked=true>
            </td>
            <td>
                <form action="">
                    <select id="category1-dropdown" name="Category1" onchange="loadCompareData()" checked=true>
                    </select>
                </form>
            </td>
        </tr>
        <tr>
            <td> Second category </td>
            <td>
                <input type="checkbox" id="enable2_checkbox" name="enable2_checkbox"onchange="updateGraph()">
            </td>
            <td>
                <form action="">
                    <select id="category2-dropdown" name="Category2" onchange="loadCompareData()">
                    </select>
                </form>
            </td>
        </tr>
        <tr>
            <td> First year </td>
            <td>
                <div class="slidecontainer">
                    <input type="range" min="1982" max="2022" value="2015" class="slider" id="min_slider"
                        oninput="updateTimeSpanSlider()">
                </div>
            </td>
            <td>
                <input type="number" name="min_input" min="1982" max="2022" value="2015" id="min_input"
                    oninput="updateTimeSpanManual()" class="input_field_class" />
            </td>
        </tr>
        <tr>
            <td> Last year </td>
            <td>
                <div class="slidecontainer">
                    <input type="range" min="1982" max="2022" value="2022" class="slider" id="max_slider"
                        oninput="updateTimeSpanSlider()">
                </div>
            </td>
            <td>
                <input type="number" name="max_input" min="1982" max="2022" value="2022" id="max_input"
                    oninput="updateTimeSpanManual()" class="input_field_class" />
            </td>
        </tr>

        <tr>
            <td> Relative Change </td>
            <td>
            </td>
            <td>
                <input type="text" name="relative_change" value="NA" id="relative_change" readonly
                    class="readonly_field_class" />
            </td>
        </tr>
        <tr>
            <td> Rescale</td>
            <td>
            <input type="checkbox" id="rescale_checkbox" name="rescale_checkbox" onchange="rescaleData()">
            </td>
        </tr>
        <tr>
            <td> Reset</td>
            <td>
            <button type="button" onclick="resetView()">Reset view</button>
            </td>
        </tr>


    </table>
    <br>
    <div class="chartBox">
        <canvas id="chartCompare"></canvas>
    </div>
    <script>
        function updateCheckboxes() {
            for (var i=1; i <= max_graphs; i++) {
                let dropdown = document.getElementById("category" + i + "-dropdown");
                if (document.getElementById("enable" + i + "_checkbox").checked) {
                    dropdown.disabled = false;
                } else {
                    dropdown.disabled = true;
                }
            }
        }

        function rescaleData() {
            updateGraph();
        }


        function updateTimeSpanSlider() {
            let min_input = document.getElementById("min_input");
            let min_slider = document.getElementById("min_slider");
            min_input.value = min_slider.value;
            let max_input = document.getElementById("max_input");
            let max_slider = document.getElementById("max_slider");
            max_input.value = max_slider.value;
            updateGraph();
        }

        function updateTimeSpanManual() {
            let min_input = document.getElementById("min_input");
            let min_slider = document.getElementById("min_slider");
            min_slider.value = min_input.value;
            let max_input = document.getElementById("max_input");
            let max_slider = document.getElementById("max_slider");
            max_slider.value = max_input.value;
            updateGraph();
        }

        function updateGraph() {
            updateCheckboxes();
            var dates = [];
            var values_dict = {};
            values_dict[1] = [];
            values_dict[2] = [];
            labels_dict = {};
            colors_dict = {};
            colors_dict[1] = "rgb(75, 192, 192)";
            colors_dict[2] = "rgb(255, 0, 0)";
            var values1 = [];
            var values2 = [];
            var min_slider = document.getElementById("min_slider");
            var max_slider = document.getElementById("max_slider");
            var lower_date = new Date(min_slider.value - 1, 11, 31);
            var upper_date = new Date(max_slider.value, 12, 31);
            let rescale_checkbox = document.getElementById("rescale_checkbox");
            for (var j = 1; j <= max_graphs; j++) {
                let rescaled = false;
                let dropdown = document.getElementById("category" + j + "-dropdown");
                let category = dropdown.options[dropdown.selectedIndex].value;
                labels_dict[j] = category;
                rescale_value = null;
                for (var i in loadedData) {
                    var current_date = new Date(loadedData[i]["Date"]);
                    if (current_date.getTime() >= lower_date.getTime() && current_date.getTime() <= upper_date.getTime()) {
                        if (j == 1) {
                            dates.push(loadedData[i]["Date"]);
                        }
                        if (!rescaled && loadedData[i][category] != null) {
                            rescaled = true;
                            rescale_value = 100;
                            if (rescale_checkbox.checked) {
                                rescale_value = loadedData[i][category];
                            }
                        }
                        values_dict[j].push(loadedData[i][category] / rescale_value * 100);
                    }

                }
                let relative_change_element = document.getElementById("relative_change");
                let relative_growth_string = 'NA';
                if (values_dict[j][0] != null && values_dict[j][0] !== 0) {
                    let relative_growth = (values_dict[j][values_dict[j].length - 1] / values_dict[j] - 1) * 100;
                    relative_growth_string = relative_growth.toFixed(2) + "%";
                }


                relative_change_element.value = relative_growth_string;
        }
            let dataset = [];
            for (var i=1; i <= max_graphs; i++) {
                let dropdown = document.getElementById("category" + i + "-dropdown");
                if (document.getElementById("enable" + i + "_checkbox").checked) {
                    let data_element = {
                        label: labels_dict[i],
                        borderColor: colors_dict[i],
                        data: values_dict[i],
                    };
                    dataset.push(data_element);
                }

            }
            var chartdata = {
                labels: dates,
                datasets: dataset
            };
            chartCompare.config.data = chartdata;
            chartCompare.update();
            resetView();

        }

        var loadCompareCategories = function () {
            $.ajax({
                url: baseURL + "db_finspresso/get_compare_categories.php",
                method: "GET",
                success: function (data) {
                    let category_list = [];
                    for (var i in data) {
                        if (data[i]["Type"] == "float") {
                            category_list.push(data[i]["Field"]);
                        }
                    }
                    category_list = category_list.sort();
                    for (var j = 1; j <= max_graphs; j++) {
                        let dropdown = document.getElementById("category" + j +"-dropdown");
                        for (cat of category_list) {
                            let option = document.createElement("option");
                            option.text = cat;
                            option.value = cat;
                            dropdown.add(option);
                        }
                        dropdown.selectedIndex = 0;
                    }

                    loadCompareData();
                },
                error: function (data) {
                    console.log(data);
                },
            });
        };

        var loadCompareData = function () {
            let dropdown1 = document.getElementById("category1-dropdown");
            const category1 = dropdown1.options[dropdown1.selectedIndex].value;
            let dropdown2 = document.getElementById("category2-dropdown");
            const category2 = dropdown2.options[dropdown2.selectedIndex].value;
            let requestURL = baseURL + "db_finspresso/get_compare_evolution_data.php?cat1=" + "`" + category1 + "`" + "&cat2=" + "`" + category2 + "`";
            $.ajax({
                url: requestURL,
                method: "GET",
                success: function (data) {
                    loadedData = data;
                    updateGraph();
                },
                error: function (data) {
                    console.log(data);
                },
            });
        };

        function resetView() {
            resetZoom();
        }

        function resetZoom() {
            chartCompare.resetZoom();
        }

        var baseURL = "";
        if (location.hostname === "www.finspresso.com") {
            baseURL = "https://www.finspresso.com/";
        }
        const labels = [1, 2];
        var loadedData = 0;
        let dataInit = {
            labels: labels,
            datasets: [
                {
                    label: "NA",
                    data: [],
                    fill: false,
                    borderColor: "rgb(75, 192, 192)",
                    tension: 0.1,
                },
            ],
        };
        const configInit = {
            type: "line",
            data: dataInit,
            options: {
                plugins: {
                    zoom :{
                        zoom: {
                            wheel: {
                                enabled: true
                            }
                        },
                        pan: {
                            enabled: true
                        }
                    },
                    legend: {
                        display: true
                    }
                }
          }
        };
        var max_graphs = 2;
        var ctxCompare = document.getElementById("chartCompare").getContext("2d");
        var chartCompare = new Chart(ctxCompare, configInit);
        loadCompareCategories();
    </script>
</body>

</html>
